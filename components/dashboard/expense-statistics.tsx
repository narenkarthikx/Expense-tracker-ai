"use client"

import { useEffect, useState } from "react"
import { Card } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import { createClient } from "@/lib/supabase-client"
import { 
  BarChart3,
  Calendar,
  TrendingUp,
  Users,
  DollarSign,
  Clock
} from "lucide-react"

interface ExpenseStats {
  totalExpenses: number
  avgDaily: number
  avgWeekly: number
  mostExpensiveDay: { day: string; amount: number }
  expenseFrequency: { daily: number; weekly: number }
  topSpendingHour: number
  categoryCount: number
  aiScannedCount: number
  manualEntryCount: number
}\n\nexport default function ExpenseStatistics() {\n  const [stats, setStats] = useState<ExpenseStats | null>(null)\n  const [loading, setLoading] = useState(true)\n  const supabase = createClient()\n\n  useEffect(() => {\n    fetchStatistics()\n  }, [])\n\n  const fetchStatistics = async () => {\n    try {\n      const { data: { user } } = await supabase.auth.getUser()\n      if (!user) return\n\n      const now = new Date()\n      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1)\n      \n      const { data: expenses } = await supabase\n        .from(\"expenses\")\n        .select(\"*\")\n        .eq(\"user_id\", user.id)\n        .gte(\"date\", monthStart.toISOString().split('T')[0])\n\n      if (!expenses || expenses.length === 0) {\n        setStats({\n          totalExpenses: 0,\n          avgDaily: 0,\n          avgWeekly: 0,\n          mostExpensiveDay: { day: 'N/A', amount: 0 },\n          expenseFrequency: { daily: 0, weekly: 0 },\n          topSpendingHour: 12,\n          categoryCount: 0,\n          aiScannedCount: 0,\n          manualEntryCount: 0\n        })\n        return\n      }\n\n      // Calculate statistics\n      const totalAmount = expenses.reduce((sum, e) => sum + e.amount, 0)\n      const daysInMonth = now.getDate()\n      const weeksInMonth = Math.ceil(daysInMonth / 7)\n      \n      // Group by day to find most expensive\n      const dailyTotals: { [key: string]: number } = {}\n      expenses.forEach(e => {\n        const day = new Date(e.date).toLocaleDateString('en-US', { \n          weekday: 'long', \n          month: 'short', \n          day: 'numeric' \n        })\n        dailyTotals[day] = (dailyTotals[day] || 0) + e.amount\n      })\n      \n      const mostExpensiveDay = Object.entries(dailyTotals)\n        .sort(([,a], [,b]) => b - a)[0] || ['No data', 0]\n\n      // Category count\n      const categories = new Set(expenses.map(e => e.category || 'Other'))\n      \n      // AI vs Manual count\n      const aiScanned = expenses.filter(e => e.ai_confidence && e.ai_confidence > 0.5)\n      const manualEntry = expenses.filter(e => !e.ai_confidence || e.ai_confidence <= 0.5)\n\n      // Frequency analysis\n      const uniqueDays = new Set(expenses.map(e => e.date))\n      const expenseFrequency = {\n        daily: expenses.length / daysInMonth,\n        weekly: expenses.length / weeksInMonth\n      }\n\n      setStats({\n        totalExpenses: expenses.length,\n        avgDaily: totalAmount / daysInMonth,\n        avgWeekly: totalAmount / weeksInMonth,\n        mostExpensiveDay: { \n          day: mostExpensiveDay[0], \n          amount: mostExpensiveDay[1] \n        },\n        expenseFrequency,\n        topSpendingHour: 14, // Placeholder - could be calculated from created_at\n        categoryCount: categories.size,\n        aiScannedCount: aiScanned.length,\n        manualEntryCount: manualEntry.length\n      })\n      \n    } finally {\n      setLoading(false)\n    }\n  }\n\n  if (loading) {\n    return (\n      <Card className=\"p-6\">\n        <div className=\"animate-pulse space-y-4\">\n          <div className=\"h-4 bg-muted rounded w-1/4\"></div>\n          <div className=\"grid grid-cols-2 gap-4\">\n            {[1, 2, 3, 4, 5, 6].map(i => (\n              <div key={i} className=\"space-y-2\">\n                <div className=\"h-3 bg-muted rounded w-full\"></div>\n                <div className=\"h-2 bg-muted rounded w-2/3\"></div>\n              </div>\n            ))}\n          </div>\n        </div>\n      </Card>\n    )\n  }\n\n  if (!stats) return null\n\n  const statItems = [\n    {\n      icon: <BarChart3 className=\"w-4 h-4\" />,\n      label: \"Total Expenses\",\n      value: stats.totalExpenses.toString(),\n      subtext: \"this month\",\n      color: \"text-blue-600\"\n    },\n    {\n      icon: <Calendar className=\"w-4 h-4\" />,\n      label: \"Daily Average\",\n      value: `â‚¹${stats.avgDaily.toFixed(0)}`,\n      subtext: \"per day\",\n      color: \"text-green-600\"\n    },\n    {\n      icon: <TrendingUp className=\"w-4 h-4\" />,\n      label: \"Most Expensive Day\",\n      value: `â‚¹${stats.mostExpensiveDay.amount.toFixed(0)}`,\n      subtext: stats.mostExpensiveDay.day.length > 15 \n        ? stats.mostExpensiveDay.day.substring(0, 12) + '...' \n        : stats.mostExpensiveDay.day,\n      color: \"text-orange-600\"\n    },\n    {\n      icon: <Users className=\"w-4 h-4\" />,\n      label: \"Categories Used\",\n      value: stats.categoryCount.toString(),\n      subtext: \"different types\",\n      color: \"text-purple-600\"\n    },\n    {\n      icon: <DollarSign className=\"w-4 h-4\" />,\n      label: \"Expense Frequency\",\n      value: `${stats.expenseFrequency.daily.toFixed(1)}`,\n      subtext: \"expenses/day\",\n      color: \"text-indigo-600\"\n    },\n    {\n      icon: <Clock className=\"w-4 h-4\" />,\n      label: \"AI vs Manual\",\n      value: `${stats.aiScannedCount}/${stats.manualEntryCount}`,\n      subtext: \"AI/Manual entries\",\n      color: \"text-emerald-600\"\n    }\n  ]\n\n  return (\n    <Card className=\"p-6 bg-gradient-to-br from-slate-50 to-blue-50 dark:from-slate-950/50 dark:to-blue-950/20\">\n      <div className=\"space-y-4\">\n        <h3 className=\"text-lg font-semibold flex items-center gap-2\">\n          <BarChart3 className=\"w-5 h-5 text-primary\" />\n          Expense Statistics\n        </h3>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n          {statItems.map((item, index) => (\n            <div \n              key={index}\n              className=\"bg-background/60 rounded-lg p-4 space-y-2 hover:bg-background/80 transition-colors\"\n            >\n              <div className=\"flex items-center justify-between\">\n                <div className={`p-2 rounded-lg bg-muted/50 ${item.color}`}>\n                  {item.icon}\n                </div>\n                <Badge variant=\"outline\" className=\"text-xs\">\n                  Nov '25\n                </Badge>\n              </div>\n              \n              <div className=\"space-y-1\">\n                <p className=\"text-lg font-bold\" suppressHydrationWarning>\n                  {item.value}\n                </p>\n                <p className=\"text-xs font-medium text-muted-foreground\">\n                  {item.label}\n                </p>\n                <p className=\"text-xs text-muted-foreground\">\n                  {item.subtext}\n                </p>\n              </div>\n            </div>\n          ))}\n        </div>\n\n        {/* Quick Insights */}\n        <div className=\"bg-muted/30 rounded-lg p-4 space-y-2\">\n          <p className=\"text-sm font-medium\">ðŸ“Š Quick Insights</p>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-2 text-xs text-muted-foreground\">\n            <p>â€¢ Weekly spending: â‚¹{stats.avgWeekly.toFixed(0)}</p>\n            <p>â€¢ {stats.aiScannedCount > 0 \n              ? `${((stats.aiScannedCount / stats.totalExpenses) * 100).toFixed(0)}% AI scanned` \n              : 'Try AI receipt scanning!'}</p>\n            <p>â€¢ Active tracking: {stats.categoryCount} categories</p>\n            <p>â€¢ Entry rate: {stats.expenseFrequency.daily.toFixed(1)} expenses/day</p>\n          </div>\n        </div>\n      </div>\n    </Card>\n  )\n}"}}]